<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
	<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>经文阅读</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="./resources/js/element-index-2.13.0.js"></script> 
    <!--<script src="./resources/js/axios.min.js"></script> -->
	<script src="./resources/js/jquery-3.4.1.min.js"></script>
	<script src="./resources/js/myutils.js"></script>	
	<script src="./resources/js/FontsLib.js"></script>
    <script src="./resources/js/TraditionToSimple_CN.js"></script>		
	<link rel="shortcut icon" href="./resources/images/fojing256px.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./resources/css/element-index-2.13.0.css">
	<style>
	  .el-row {
		margin-bottom: 20px;
		&:last-child {
		  margin-bottom: 0;
		}
	  }
	  .el-col {
		border-radius: 4px;
	  }
	  .grid-content {
		border-radius: 4px;
		min-height: 36px;
		margin-top:25px;
	  }
	  .el-dropdown-link {
	    margin-left:-78px;
		font-size:24px;
		position:relative;
		top:30px;
	  }
	  .explainContextclass {
		position:fixed;
		top:14px;
	  }
	  .tools{
		margin-left:246px;
		margin-bottom:24px;
	  }
	  .left{
		position:fixed;
	  }
  	  .list1  {
	    max-height: 650px;
	    
	  }	
	  .list2  {
	    max-height: 660px;
	  		  
	  }			
	  /* 未访问链接*/
	  a:link {
	  	text-decoration:none;
	  }  
	  /* 已访问链接 */		
	  a:visited {
	  	text-decoration:none;
	  } 
	  /* 鼠标移动到链接上 */		
	  a:hover {
	  	text-decoration:none;
		cursor:pointer;
	  }  
	  /* 鼠标点击时 */
	  a:active {
	  	text-decoration:none;
	  }
	  ul{
	  	list-style-type: none; /*去掉标点*/
	  	line-height:26px;
	  	margin-left:-27px;
	  }
	  #translate{
		font-family:Cursive; 
		font-size:114%; 
		color:#868181;
	  }
	  #failmsg {
		margin-top:67px;
		margin-left: 108px;
	  }
	  /*阅读进度条*/
	  #content_progress {
	  	  /* Positioning */
	  	  position: fixed;
	  	  left: 0;
	  	  top: 0;
	  	  z-index: 1000;
	  	  width: 100%;
	  	  height: 2px;
	  	  -webkit-appearance: none;
	  	  -moz-appearance: none;
	  	  appearance: none;
	  	  border: none;
	  	  background-color: transparent;
	  	  color: #be9567;
	  }
      
	  #content_progress::-webkit-progress-bar {
	  	  background-color: transparent;
	  }
      
	  #content_progress::-webkit-progress-value {
	  	  background-color: #be9567;
	  }
      
	  #content_progress::-moz-progress-bar {
	  	  background-color: #be9567;
	  }
	  #booknameid {
		margin: auto;
		top: 0;
		margin-left: 133px;
		height:26px;
		width:935px;
		position:fixed;
		margin-bottom:4px;
		text-align:center;
		background-color:white;
		z-index:999;
		color:#be9567;
	  }	
	  .selectedChapter {
		color:#be9567;
	  }
	</style>	
  </head>
  <body>
  <div id="app">
	<progress id="content_progress" value="0"></progress>
	<el-row >
		<div id='booknameid'>{{bookname}}</div>
	</el-row >	
	<el-row >
	  <!-- 左侧区域 返回主页图标 + 目录-->
	  <el-col :span="2" :offset="1">
		  <div class="left">
			<a href="index.html"><img src="./resources/images/fojing.png" alt="picture" width="80px" height="80px" /></a>
			<el-scrollbar 	
				wrap-class="list1" 
				wrap-style="font-family:Cursive;" 
				view-style="" 
				view-class="view-box" 
				:native="false">
				<ul>
					<li v-for="content in contents"><a name="chapterlink" :id="content.id"  v-on:click="selectchapter(content.url)">{{content.name}}</a></li>
				</ul>
			</el-scrollbar>
		  </div>		  
	  </el-col> 
	  <!-- 中间区域 经文-->
	  <el-col :span="13"  :offset="4" v-loading="loading" element-loading-text="正在加载">
			<div id="failmsg" v-if="requesterror">加载失败请刷新重试</div>
			<div class="grid-content" id="book" style="font-family:Cursive;font-size:140%" @mouseup = "selectcontent"></div>	
	  </el-col>
	  <!-- 右侧区域 发送kindle + 翻译 + 改变字体大小 -->
	  <el-col :span="4"  :offset="1">
		<div class='explainContextclass'>
			<div class="tools">
				<a title='发送到kindle'><i class="el-icon-s-promotion"></i></a>
				<!--&nbsp &nbsp				
				<a title='繁简翻译'>繁/简</a>-->
			</div>
			<div id='translate'>
				<el-scrollbar 	
					wrap-class="list2" 
					view-class="view-box1" 
					:native="false">
					<div>{{simpleChineseContext}}</div>
					<div v-for="result in explainContext">
						{{result.term}}: {{result.desc.substring(0,result.desc.length-5)}}
						<br/>
						&nbsp &nbsp &nbsp &nbsp--《{{result.dict_name_zh}}》
					</div>
				</el-scrollbar>
			</div>
		</div>
	  </el-col>	
	</el-row>	
  </div>
  </body>
  <script>	
    new Vue({
      el: '#app',
      data: {
		info:null,
		contents:[],
        form: {
          name: '',
          region: '',
          date1: '',
          date2: '',
          delivery: false,
          type: [],
          resource: '',
          desc: ''
        },
        formLabelWidth: '120px',
		explainContext: null,
		loading:false,
		simpleChineseContext:'',
		requesterror:false,
		bookname:''
	  },
	  mounted: function () {
	    var work = util.getQueryStr("work");
		var juan = util.getQueryStr("juan");
		this.bookname = util.getQueryStr("bookname");
		for (i = 1; i <=juan; i++) { 
			this.contents.push({name:'卷'+i , 
								url:'https://cbdata.dila.edu.tw/v1.2/download/html/' + work + '_' + util.PrefixInteger(i,3) + '.html',
								id: 'chapter'+i
							});
		}
		this.axiosrequest('https://cbdata.dila.edu.tw/v1.2/download/html/' + work + '_001.html','init');
		//阅读进度条
		document.addEventListener('DOMContentLoaded', function () {
			  var winHeight = window.innerHeight,
					docHeight = document.documentElement.scrollHeight,
					progressBar = document.querySelector('#content_progress');
			  progressBar.max = docHeight - winHeight;
			  progressBar.value = window.scrollY;

			  document.addEventListener('scroll', function () {
					progressBar.max = document.documentElement.scrollHeight - window.innerHeight;
					progressBar.value = window.scrollY;
			  });
		});		
	  },	 
	  methods: {
		selectchapter: function(url){
			//选择章节后，此章节目录文字样式改变（先清空之前样式）
			var items = document.getElementsByName('chapterlink');
			for(i=0;i<items.length;i++){
				items[i].className='';
			}
			var chapterid = window.event.target.id;
			document.getElementById(chapterid).className = 'selectedChapter';
			
			this.axiosrequest(url);
		},
		axiosrequest: function (url,param1){
			var _self=this;
			_self.loading = true;
			_self.requesterror = false;
			$.ajax({
				url: url,    
				dataType: "html",
				async: true,
				type: "GET",   //请求方式
				success: function(response) {
					document.getElementById('book').innerHTML = response;
					_self.loading = false;
					//新章节从第一行开始展示
					document.body.scrollTop = document.documentElement.scrollTop = 0;
					if(param1 == 'init'){
						//初始化时加载第一章节，此章节目录文字样式改变
						document.getElementById('chapter1').className='selectedChapter';
					}	
				},
				error: function() {
					_self.requesterror = true;
					_self.loading = false;		
				}
			});
		},
		/*
		*获取鼠标选中文本，然后繁简翻译、查询佛学词典
		*/
		selectcontent: function (e) {
		    var content = window.getSelection().toString();
			//未选中，避免无缘由滥用接口
			if(content == null && content == ''){
				return;
			}		
			var t2s = new TraditionToSimple_CN(); 
			this.simpleChineseContext = t2s.toSimplized(content);
			//选中内容过多均不查询词典，避免无缘由滥用接口
			if(content.length > 10){
				return;
			}
			var url = 'http://glossaries.dila.edu.tw/search.json?type=match&term=' + content
			var _self=this;
			$.ajax({
				url: url,    
				dataType: "json",
				async: true,
				type: "GET",
				success: function(response) {
					_self.explainContext = response.filter(function(item){
						return item.dict_name_zh === "丁福保佛學大辭典";
					});		
				}
			});			
		}
	  }
    }) 
  </script>
</html>
